---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import SEOHead from '../../components/SEOHead.astro';
import Breadcrumb from '../../components/Breadcrumb.astro';
import CopyButton from '../../components/CopyButton.astro';
import RelatedContent from '../../components/RelatedContent.astro';

export async function getStaticPaths() {
  const entries = await getCollection('skills');
  return entries.map((entry) => ({
    params: { slug: entry.slug },
    props: { entry },
  }));
}

const { entry } = Astro.props;
const { Content } = await entry.render();

const wordCount = entry.body?.split(/\s+/).length ?? 0;
const readTime = Math.max(1, Math.ceil(wordCount / 200));

const dateFormatted = entry.data.date.toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'long',
  day: 'numeric',
});

const canonicalURL = new URL(Astro.url.pathname, Astro.site).toString();
---

<BaseLayout title={entry.data.title} description={entry.data.description}>
  <SEOHead
    slot="head"
    title={entry.data.title}
    description={entry.data.description}
    url={canonicalURL}
    date={entry.data.date}
    tags={entry.data.tags}
  />

  <main class="container detail-page">
    <Breadcrumb
      items={[
        { label: 'Home', href: '/' },
        { label: 'Skills', href: '/skills/' },
        { label: entry.data.title },
      ]}
    />

    <header class="detail-header">
      <h1>{entry.data.title}</h1>
      <div class="detail-meta">
        <time datetime={entry.data.date.toISOString()}>{dateFormatted}</time>
        <span class={`difficulty-badge difficulty-${entry.data.difficulty}`}>
          {entry.data.difficulty}
        </span>
        <span class="read-time">{readTime} min read</span>
      </div>
      <div class="detail-tags">
        {entry.data.tags.map((tag: string) => (
          <span class="tag-chip">{tag}</span>
        ))}
      </div>
    </header>

    <article class="detail-body prose">
      <Content />
    </article>

    <aside class="ad-placeholder" aria-label="Advertisement">
      <div class="ad-slot">Ad Unit</div>
    </aside>

    <RelatedContent
      currentSlug={entry.slug}
      category="skills"
      tags={entry.data.tags}
    />
  </main>

  <CopyButton content={entry.body ?? ''} />
</BaseLayout>

<style>
  .detail-page {
    padding-block: var(--space-8) var(--space-16);
    max-width: 800px;
  }

  .detail-header {
    margin-top: var(--space-6);
    margin-bottom: var(--space-8);
  }

  .detail-header h1 {
    font-size: var(--text-4xl);
    margin-bottom: var(--space-4);
  }

  .detail-meta {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: var(--space-3);
    font-size: var(--text-sm);
    color: var(--color-text-secondary);
    margin-bottom: var(--space-3);
  }

  .difficulty-badge {
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    font-size: var(--text-xs);
    padding: 0.15em 0.6em;
    border-radius: var(--radius-full);
  }

  .difficulty-beginner {
    color: var(--color-beginner);
    background: color-mix(in srgb, var(--color-beginner) 15%, transparent);
  }

  .difficulty-intermediate {
    color: var(--color-intermediate);
    background: color-mix(in srgb, var(--color-intermediate) 15%, transparent);
  }

  .difficulty-advanced {
    color: var(--color-advanced);
    background: color-mix(in srgb, var(--color-advanced) 15%, transparent);
  }

  .read-time {
    color: var(--color-text-secondary);
  }

  .detail-tags {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-2);
  }

  .tag-chip {
    font-size: var(--text-xs);
    padding: 0.2em 0.7em;
    background: color-mix(in srgb, var(--color-secondary) 20%, transparent);
    color: var(--color-text-secondary);
    border-radius: var(--radius-full);
    border: 1px solid color-mix(in srgb, var(--color-secondary) 30%, transparent);
  }

  .detail-body {
    margin-bottom: var(--space-8);
  }

  .prose :global(h2) {
    font-size: var(--text-2xl);
    margin-top: var(--space-8);
    margin-bottom: var(--space-4);
  }

  .prose :global(h3) {
    font-size: var(--text-xl);
    margin-top: var(--space-6);
    margin-bottom: var(--space-3);
  }

  .prose :global(p) {
    margin-bottom: var(--space-4);
    max-width: none;
  }

  .prose :global(ul),
  .prose :global(ol) {
    margin-bottom: var(--space-4);
    padding-left: var(--space-6);
    color: var(--color-text-secondary);
  }

  .prose :global(ul) {
    list-style: disc;
  }

  .prose :global(ol) {
    list-style: decimal;
  }

  .prose :global(li) {
    margin-bottom: var(--space-2);
  }

  .prose :global(pre) {
    margin-bottom: var(--space-4);
  }

  .prose :global(blockquote) {
    border-left: 3px solid var(--color-primary);
    padding-left: var(--space-4);
    margin-bottom: var(--space-4);
    color: var(--color-text-secondary);
    font-style: italic;
  }

  .prose :global(hr) {
    border: none;
    border-top: 1px solid var(--color-border);
    margin-block: var(--space-8);
  }

  .prose :global(table) {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: var(--space-4);
    font-size: var(--text-sm);
  }

  .prose :global(th),
  .prose :global(td) {
    padding: var(--space-2) var(--space-3);
    border: 1px solid var(--color-border);
    text-align: left;
  }

  .prose :global(th) {
    background: var(--color-surface);
    font-weight: 600;
    color: var(--color-text);
  }

  .ad-placeholder {
    padding: var(--space-8) 0;
    text-align: center;
  }

  .ad-slot {
    padding: var(--space-8);
    border: 1px dashed var(--color-border);
    border-radius: var(--radius-md);
    color: var(--color-text-secondary);
    font-size: var(--text-sm);
  }

  @media (max-width: 640px) {
    .detail-header h1 {
      font-size: var(--text-3xl);
    }
  }
</style>
